{
  "id": "3",
  "title": "Transaction Previous Product",
  "difficulty": "Hard",
  "category": "Window Functions",
  "description": "**Customer Transactions**\n\nYou have a DataFrame of customer transactions with schema:\n\n| Column Name | Data Type |\n|-------------|-----------|\n| customer_id | string    |\n| product_id  | string    |\n| date        | string    |\n| quantity    | integer   |\n\nAdd a column `previous_product` that contains the product_id from the customer's previous transaction (ordered by date). Also add a `date_and_product` column concatenating date and previous_product.\n\n**Example**\n\n| customer_id | product_id | date       | quantity |\n|-------------|------------|------------|----------|\n| CUST1       | PROD1      | 2023-01-01 | 2        |\n| CUST1       | PROD2      | 2023-02-10 | 3        |\n\n**Output** includes previous_product and date_and_product columns",
  "starter_code": "def etl(transactions):\n    # Write code here\n    pass",
  "test_setup": "from pyspark.sql import SparkSession\nfrom pyspark.sql import functions as F\nfrom pyspark.sql import Window as W\n\nspark = SparkSession.builder.appName('test').getOrCreate()\n\ndata = [\n    ('CUST1', 'PROD1', '2023-01-01', 2),\n    ('CUST1', 'PROD2', '2023-02-10', 3),\n    ('CUST1', 'PROD3', '2023-03-15', 1),\n    ('CUST2', 'PROD1', '2023-01-05', 5),\n    ('CUST2', 'PROD4', '2023-02-20', 2)\n]\ncolumns = ['customer_id', 'product_id', 'date', 'quantity']\ntransactions = spark.createDataFrame(data, columns)",
  "test_validation": "result = etl(transactions)\nassert result is not None, 'Function returned None'\nassert 'previous_product' in result.columns, 'Missing previous_product column'\nassert 'date_and_product' in result.columns, 'Missing date_and_product column'\nprint('âœ… TEST PASSED!')",
  "hints": [
    "Define a Window with partitionBy and orderBy",
    "Use F.lag() to get previous row value",
    "Handle null values with F.when() and F.otherwise()"
  ],
  "solution": "def etl(transactions):\n    windowSpec = W.partitionBy('customer_id').orderBy('date')\n    \n    transactions = transactions.withColumn(\n        'previous_product',\n        F.lag(transactions['product_id']).over(windowSpec)\n    )\n    \n    transactions = transactions.withColumn(\n        'previous_product',\n        F.when(F.col('previous_product').isNull(), 'None')\n        .otherwise(F.col('previous_product'))\n    )\n    \n    transactions = transactions.withColumn(\n        'date_and_product',\n        F.concat_ws(' ', transactions['date'], transactions['previous_product'])\n    )\n    \n    return transactions"
}
